<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Checklists</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.3/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --salmon-600: #FA8072;
        }
        .text-salmon-600 {
            color: var(--salmon-600);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // CSV Parser Functions
        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    complete: (results) => {
                        try {
                            const data = results.data;
                            const items = data
                                .filter(row => row.length > 0 && row[0]?.trim() !== '')
                                .map(row => ({
                                    text: row[0].trim(),
                                    note: row[1]?.trim() || ''
                                }));
                            
                            if (items.length === 0) {
                                reject(new Error('CSVファイルにデータが見つかりません'));
                                return;
                            }
                            resolve(items);
                        } catch {
                            reject(new Error('CSVファイルの解析に失敗しました'));
                        }
                    },
                    error: () => {
                        reject(new Error('CSVファイルの読み込みに失敗しました'));
                    }
                });
            });
        }

        function exportToCSV(items) {
            const csvData = items.map(item => [item.text, item.note || '']);
            return Papa.unparse(csvData);
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Checklist Manager Hook
        function useChecklistManager() {
            const [manager, setManager] = useState({
                checklists: [],
                activeChecklistId: null
            });

            useEffect(() => {
                const saved = localStorage.getItem('checklistManager');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        const checklistsWithDates = parsed.checklists.map(checklist => ({
                            ...checklist,
                            createdAt: new Date(checklist.createdAt)
                        }));
                        setManager({
                            checklists: checklistsWithDates,
                            activeChecklistId: parsed.activeChecklistId
                        });
                    } catch (error) {
                        console.error('LocalStorageからの読み込みに失敗:', error);
                    }
                }
            }, []);

            useEffect(() => {
                if (manager.checklists.length > 0 || localStorage.getItem('checklistManager')) {
                    localStorage.setItem('checklistManager', JSON.stringify(manager));
                }
            }, [manager]);

            const addChecklist = (name, items = []) => {
                if (manager.checklists.length >= 20) {
                    throw new Error('チェックリストは最大20個まで作成できます');
                }

                if (items.length > 200) {
                    throw new Error('チェックリストの項目は最大200個までです');
                }

                const newChecklist = {
                    id: Date.now().toString(),
                    name,
                    items: items.map((item, index) => ({
                        id: `${Date.now()}-${index}`,
                        text: item.text,
                        note: item.note,
                        completed: false
                    })),
                    createdAt: new Date()
                };

                setManager(prev => ({
                    checklists: [...prev.checklists, newChecklist],
                    activeChecklistId: newChecklist.id
                }));

                return newChecklist;
            };

            const updateChecklist = (checklistId, updatedChecklist) => {
                setManager(prev => ({
                    ...prev,
                    checklists: prev.checklists.map(checklist =>
                        checklist.id === checklistId ? updatedChecklist : checklist
                    )
                }));
            };

            const deleteChecklist = (checklistId) => {
                setManager(prev => {
                    const newChecklists = prev.checklists.filter(checklist => checklist.id !== checklistId);
                    let newActiveId = prev.activeChecklistId;
                    
                    if (prev.activeChecklistId === checklistId) {
                        newActiveId = newChecklists.length > 0 ? newChecklists[0].id : null;
                    }

                    const newState = {
                        checklists: newChecklists,
                        activeChecklistId: newActiveId
                    };

                    if (newChecklists.length === 0) {
                        localStorage.removeItem('checklistManager');
                    }

                    return newState;
                });
            };

            const setActiveChecklist = (checklistId) => {
                setManager(prev => ({
                    ...prev,
                    activeChecklistId: checklistId
                }));
            };

            const getActiveChecklist = () => {
                return manager.checklists.find(checklist => checklist.id === manager.activeChecklistId) || null;
            };

            const reorderChecklists = (newChecklists) => {
                setManager(prev => ({
                    ...prev,
                    checklists: newChecklists
                }));
            };

            return {
                manager,
                addChecklist,
                updateChecklist,
                deleteChecklist,
                setActiveChecklist,
                getActiveChecklist,
                reorderChecklists
            };
        }

        // TabList Component
        function TabList({ checklists, activeChecklistId, onTabClick, onTabClose, onTabRename, onTabReorder }) {
            const [editingTabId, setEditingTabId] = useState(null);
            const [editingName, setEditingName] = useState('');
            const [draggedTabId, setDraggedTabId] = useState(null);

            if (checklists.length === 0) {
                return null;
            }

            const handleTabNameClick = (e, checklist) => {
                e.stopPropagation();
                setEditingTabId(checklist.id);
                setEditingName(checklist.name);
            };

            const handleSave = () => {
                if (editingTabId && editingName.trim()) {
                    onTabRename(editingTabId, editingName.trim());
                }
                setEditingTabId(null);
                setEditingName('');
            };

            const handleCancel = () => {
                setEditingTabId(null);
                setEditingName('');
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    handleSave();
                } else if (e.key === 'Escape') {
                    handleCancel();
                }
            };

            const handleDragStart = (tabId) => (e) => {
                if (editingTabId) return;
                setDraggedTabId(tabId);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragEnd = () => {
                setDraggedTabId(null);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDrop = (targetTabId) => (e) => {
                e.preventDefault();
                
                if (!draggedTabId || draggedTabId === targetTabId || editingTabId) {
                    return;
                }

                const draggedIndex = checklists.findIndex(c => c.id === draggedTabId);
                const targetIndex = checklists.findIndex(c => c.id === targetTabId);

                if (draggedIndex === -1 || targetIndex === -1) {
                    return;
                }

                const newChecklists = [...checklists];
                const [draggedItem] = newChecklists.splice(draggedIndex, 1);
                newChecklists.splice(targetIndex, 0, draggedItem);

                onTabReorder(newChecklists);
                setDraggedTabId(null);
            };

            return (
                <div className="border-b border-gray-200 mb-6">
                    <nav className="-mb-px flex space-x-2 sm:space-x-8 overflow-x-auto pb-1">
                        {checklists.map((checklist) => {
                            const isActive = checklist.id === activeChecklistId;
                            const isEditing = editingTabId === checklist.id;
                            const isDragging = draggedTabId === checklist.id;
                            
                            return (
                                <div
                                    key={checklist.id}
                                    draggable={!isEditing}
                                    onDragStart={handleDragStart(checklist.id)}
                                    onDragEnd={handleDragEnd}
                                    onDragOver={handleDragOver}
                                    onDrop={handleDrop(checklist.id)}
                                    className={`group flex items-center py-2 px-2 sm:px-1 border-b-2 font-medium text-xs sm:text-sm whitespace-nowrap transition-opacity ${
                                        isActive
                                            ? 'border-blue-500 text-blue-600'
                                            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                    } ${isDragging ? 'opacity-50' : 'opacity-100'}`}
                                    style={{ cursor: !isEditing ? 'grab' : 'default' }}
                                    onClick={() => !isEditing && onTabClick(checklist.id)}
                                >
                                    {isEditing ? (
                                        <input
                                            type="text"
                                            value={editingName}
                                            onChange={(e) => setEditingName(e.target.value)}
                                            onBlur={handleSave}
                                            onKeyDown={handleKeyDown}
                                            className="w-24 sm:w-32 px-1 py-0.5 border border-blue-500 rounded text-xs sm:text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
                                            autoFocus
                                            onClick={(e) => e.stopPropagation()}
                                        />
                                    ) : (
                                        <span 
                                            className="truncate max-w-24 sm:max-w-32 cursor-pointer"
                                            onDoubleClick={(e) => handleTabNameClick(e, checklist)}
                                            title="ダブルクリックして名前を変更"
                                        >
                                            {checklist.name}
                                        </span>
                                    )}
                                    <button
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            if (confirm(`"${checklist.name}"を削除しますか？\n\nこの操作は取り消せません。`)) {
                                                onTabClose(checklist.id);
                                            }
                                        }}
                                        className="ml-1 sm:ml-2 p-1 rounded-full hover:bg-red-100 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-all"
                                        title="タブを削除"
                                    >
                                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            );
                        })}
                    </nav>
                </div>
            );
        }

        // ChecklistItem Component
        function ChecklistItem({ item, isEditing, editText, isEditingNote, editNote, onToggle, onDeleteItem, onItemClick, onNoteClick, onEditTextChange, onEditNoteChange, onEditSave, onNoteEditSave, onKeyPress, onNoteKeyPress, onDragStart, onDragEnd, onDragOver, onDrop, isDragging }) {
            return (
                <div 
                    draggable={!isEditing && !isEditingNote}
                    onDragStart={onDragStart}
                    onDragEnd={onDragEnd}
                    onDragOver={onDragOver}
                    onDrop={onDrop}
                    className={`grid grid-cols-12 gap-1 sm:gap-2 p-2 bg-gray-50 rounded items-center transition-all ${isDragging ? 'opacity-50 scale-95' : 'opacity-100'}`}
                    style={{ cursor: (!isEditing && !isEditingNote) ? 'grab' : 'default' }}
                >
                    {/* ドラッグハンドル */}
                    <div className="col-span-1 flex justify-center">
                        <div className="p-1 text-gray-400 cursor-grab active:cursor-grabbing" title="ドラッグして並び替え">
                            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8h16M4 16h16" />
                            </svg>
                        </div>
                    </div>

                    {/* チェックボックス */}
                    <div className="col-span-1 flex justify-center">
                        <input
                            type="checkbox"
                            checked={item.completed}
                            onChange={() => onToggle(item.id)}
                            className="w-3 h-3 sm:w-4 sm:h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-1"
                        />
                    </div>
                    
                    {/* チェック項目 */}
                    <div className="col-span-5 sm:col-span-6">
                        {isEditing ? (
                            <input
                                type="text"
                                value={editText}
                                onChange={(e) => onEditTextChange(e.target.value)}
                                onBlur={onEditSave}
                                onKeyDown={onKeyPress}
                                className="w-full px-1 sm:px-2 py-1 border border-gray-300 rounded text-xs sm:text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
                                autoFocus
                            />
                        ) : (
                            <span
                                className={`text-xs sm:text-sm cursor-pointer hover:bg-gray-200 px-1 py-1 rounded ${item.completed ? 'line-through text-gray-500' : 'text-gray-900'}`}
                                onClick={() => onItemClick(item)}
                                title="クリックして編集"
                            >
                                {item.text}
                            </span>
                        )}
                    </div>
                    
                    {/* 備考 */}
                    <div className="col-span-4 sm:col-span-3">
                        {isEditingNote ? (
                            <input
                                type="text"
                                value={editNote}
                                onChange={(e) => onEditNoteChange(e.target.value)}
                                onBlur={onNoteEditSave}
                                onKeyDown={onNoteKeyPress}
                                className="w-full px-1 sm:px-2 py-1 border border-gray-300 rounded text-xs sm:text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
                                autoFocus
                            />
                        ) : (
                            <span
                                className={`text-xs sm:text-sm cursor-pointer hover:bg-gray-200 px-1 py-1 rounded ${item.note ? 'text-salmon-600' : 'text-gray-300'}`}
                                onClick={() => onNoteClick(item)}
                                title="クリックして備考を編集"
                            >
                                {item.note || '備考...'}
                            </span>
                        )}
                    </div>

                    {/* 削除ボタン */}
                    <div className="col-span-1 flex justify-center">
                        <button
                            onClick={() => {
                                if (confirm(`"${item.text}"を削除しますか？`)) {
                                    onDeleteItem(item.id);
                                }
                            }}
                            className="p-1 text-gray-400 hover:text-red-600 transition-colors"
                            title="項目を削除"
                        >
                            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            );
        }

        // Checklist Component
        function Checklist({ checklist, onToggle, onUpdateNote, onUpdateItem, onDeleteItem, onReorderItems, onAddItem }) {
            const [editingItemId, setEditingItemId] = useState(null);
            const [editText, setEditText] = useState('');
            const [editingNoteId, setEditingNoteId] = useState(null);
            const [editNote, setEditNote] = useState('');
            const [newItemText, setNewItemText] = useState('');
            const [draggedItemId, setDraggedItemId] = useState(null);
            const [dragOverItemId, setDragOverItemId] = useState(null);
            const completedCount = checklist.items.filter(item => item.completed).length;
            const totalCount = checklist.items.length;
            const progress = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;

            const handleNoteClick = (item) => {
                setEditingNoteId(item.id);
                setEditNote(item.note || '');
            };

            const handleNoteEditSave = () => {
                if (editingNoteId) {
                    onUpdateNote(editingNoteId, editNote.trim());
                }
                setEditingNoteId(null);
                setEditNote('');
            };

            const handleNoteKeyPress = (e) => {
                if (e.key === 'Enter') {
                    handleNoteEditSave();
                } else if (e.key === 'Escape') {
                    setEditingNoteId(null);
                    setEditNote('');
                }
            };

            const handleItemClick = (item) => {
                setEditingItemId(item.id);
                setEditText(item.text);
            };

            const handleEditSave = () => {
                if (editingItemId && editText.trim()) {
                    onUpdateItem(editingItemId, editText.trim());
                }
                setEditingItemId(null);
                setEditText('');
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    handleEditSave();
                } else if (e.key === 'Escape') {
                    setEditingItemId(null);
                    setEditText('');
                }
            };

            const handleAddItem = () => {
                if (newItemText.trim()) {
                    onAddItem(newItemText.trim());
                    setNewItemText('');
                }
            };

            const handleNewItemKeyPress = (e) => {
                if (e.key === 'Enter') {
                    handleAddItem();
                }
            };

            const handleExportCSV = () => {
                const items = checklist.items.map(item => ({
                    text: item.text,
                    note: item.note || ''
                }));
                const csvContent = exportToCSV(items);
                const filename = `${checklist.name}.csv`;
                downloadCSV(csvContent, filename);
            };

            const handleDragStart = (itemId) => (e) => {
                setDraggedItemId(itemId);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragEnd = () => {
                setDraggedItemId(null);
                setDragOverItemId(null);
            };

            const handleDragOver = (itemId) => (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                if (draggedItemId && draggedItemId !== itemId) {
                    setDragOverItemId(itemId);
                }
            };

            const handleDrop = (targetItemId) => (e) => {
                e.preventDefault();
                
                if (!draggedItemId || draggedItemId === targetItemId) {
                    return;
                }

                const draggedIndex = checklist.items.findIndex(item => item.id === draggedItemId);
                const targetIndex = checklist.items.findIndex(item => item.id === targetItemId);

                if (draggedIndex === -1 || targetIndex === -1) {
                    return;
                }

                const newItems = [...checklist.items];
                const [draggedItem] = newItems.splice(draggedIndex, 1);
                newItems.splice(targetIndex, 0, draggedItem);

                onReorderItems(newItems);
                setDraggedItemId(null);
                setDragOverItemId(null);
            };

            return (
                <div className="bg-white rounded-lg shadow-md border border-gray-200 p-6">
                    <div className="mb-4">
                        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                            <div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 text-sm text-gray-600">
                                <span className="font-medium">{completedCount}/{totalCount} 完了</span>
                                <div className="flex items-center gap-2">
                                    <div className="flex-1 bg-gray-200 rounded-full h-2 max-w-xs">
                                        <div
                                            className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                            style={{ width: `${progress}%` }}
                                        />
                                    </div>
                                    <span className="text-xs font-medium">{Math.round(progress)}%</span>
                                </div>
                            </div>
                            <button
                                onClick={handleExportCSV}
                                className="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700 transition-colors w-full sm:w-auto"
                                title="CSVファイルをダウンロード"
                            >
                                CSVエクスポート
                            </button>
                        </div>
                    </div>

                    <div className="space-y-1">
                        {checklist.items.map((item) => (
                            <ChecklistItem
                                key={item.id}
                                item={item}
                                isEditing={editingItemId === item.id}
                                editText={editText}
                                isEditingNote={editingNoteId === item.id}
                                editNote={editNote}
                                onToggle={onToggle}
                                onDeleteItem={onDeleteItem}
                                onItemClick={handleItemClick}
                                onNoteClick={handleNoteClick}
                                onEditTextChange={setEditText}
                                onEditNoteChange={setEditNote}
                                onEditSave={handleEditSave}
                                onNoteEditSave={handleNoteEditSave}
                                onKeyPress={handleKeyPress}
                                onNoteKeyPress={handleNoteKeyPress}
                                onDragStart={handleDragStart(item.id)}
                                onDragEnd={handleDragEnd}
                                onDragOver={handleDragOver(item.id)}
                                onDrop={handleDrop(item.id)}
                                isDragging={draggedItemId === item.id}
                            />
                        ))}
                    </div>

                    {/* 項目追加フォーム */}
                    <div className="mt-4 pt-4 border-t border-gray-200">
                        <div className="grid grid-cols-12 gap-1 sm:gap-2 items-center">
                            <div className="col-span-1"></div>
                            <div className="col-span-1"></div>
                            <div className="col-span-5 sm:col-span-6">
                                <input
                                    type="text"
                                    value={newItemText}
                                    onChange={(e) => setNewItemText(e.target.value)}
                                    onKeyPress={handleNewItemKeyPress}
                                    placeholder="新しい項目を追加..."
                                    className="w-full px-1 sm:px-2 py-1 border border-gray-300 rounded text-xs sm:text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
                                />
                            </div>
                            <div className="col-span-4 sm:col-span-3"></div>
                            <div className="col-span-1 flex justify-center">
                                <button
                                    onClick={handleAddItem}
                                    disabled={!newItemText.trim()}
                                    className="px-2 sm:px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                                >
                                    追加
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Main App Component
        function App() {
            const { manager, addChecklist, updateChecklist, deleteChecklist, setActiveChecklist, getActiveChecklist, reorderChecklists } = useChecklistManager();
            const [isDragOver, setIsDragOver] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const fileInputRef = useRef(null);
            const [showTextInput, setShowTextInput] = useState(false);
            const [checklistName, setChecklistName] = useState('');
            const [textInput, setTextInput] = useState('');

            const activeChecklist = getActiveChecklist();

            const handleFileSelect = async (file) => {
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    setError('CSVファイルを選択してください');
                    return;
                }

                setIsLoading(true);
                setError(null);

                try {
                    const items = await parseCSV(file);
                    const checklistName = file.name.replace('.csv', '');
                    addChecklist(checklistName, items);
                } catch (err) {
                    setError(err instanceof Error ? err.message : 'ファイルの読み込みに失敗しました');
                } finally {
                    setIsLoading(false);
                }
            };

            const handleTextInputSubmit = () => {
                if (!checklistName.trim()) {
                    setError('チェックリスト名を入力してください');
                    return;
                }

                if (!textInput.trim()) {
                    setError('チェック項目を入力してください');
                    return;
                }

                setError(null);

                try {
                    const lines = textInput.split('\n').filter(line => line.trim() !== '');
                    const items = lines.map(line => {
                        // カンマ区切りで項目と備考を分ける
                        const parts = line.split(',');
                        return {
                            text: parts[0].trim(),
                            note: parts[1]?.trim() || ''
                        };
                    });

                    if (items.length === 0) {
                        setError('チェック項目が見つかりません');
                        return;
                    }

                    addChecklist(checklistName, items);
                    setChecklistName('');
                    setTextInput('');
                    setShowTextInput(false);
                } catch (err) {
                    setError(err instanceof Error ? err.message : 'チェックリストの作成に失敗しました');
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragOver(false);
                
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                setIsDragOver(true);
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                setIsDragOver(false);
            };

            const handleFileInputChange = (e) => {
                const files = e.target.files;
                if (files && files.length > 0) {
                    handleFileSelect(files[0]);
                }
            };

            const toggleItem = (itemId) => {
                if (!activeChecklist) return;
                
                const updatedChecklist = {
                    ...activeChecklist,
                    items: activeChecklist.items.map(item =>
                        item.id === itemId ? { ...item, completed: !item.completed } : item
                    )
                };
                
                updateChecklist(activeChecklist.id, updatedChecklist);
            };

            const resetCurrentChecklist = () => {
                if (!activeChecklist) return;
                
                const updatedChecklist = {
                    ...activeChecklist,
                    items: activeChecklist.items.map(item => ({
                        ...item,
                        completed: false
                    }))
                };
                
                updateChecklist(activeChecklist.id, updatedChecklist);
            };

            const updateItemNote = (itemId, note) => {
                if (!activeChecklist) return;
                
                const updatedChecklist = {
                    ...activeChecklist,
                    items: activeChecklist.items.map(item =>
                        item.id === itemId ? { ...item, note } : item
                    )
                };
                
                updateChecklist(activeChecklist.id, updatedChecklist);
            };

            const updateItemText = (itemId, text) => {
                if (!activeChecklist) return;
                
                const updatedChecklist = {
                    ...activeChecklist,
                    items: activeChecklist.items.map(item =>
                        item.id === itemId ? { ...item, text } : item
                    )
                };
                
                updateChecklist(activeChecklist.id, updatedChecklist);
            };

            const deleteItem = (itemId) => {
                if (!activeChecklist) return;
                
                const updatedChecklist = {
                    ...activeChecklist,
                    items: activeChecklist.items.filter(item => item.id !== itemId)
                };
                
                updateChecklist(activeChecklist.id, updatedChecklist);
            };

            const reorderItems = (items) => {
                if (!activeChecklist) return;
                
                const updatedChecklist = {
                    ...activeChecklist,
                    items
                };
                
                updateChecklist(activeChecklist.id, updatedChecklist);
            };

            const addItem = (text) => {
                if (!activeChecklist) return;
                
                if (activeChecklist.items.length >= 200) {
                    setError('チェックリストの項目は最大200個までです');
                    return;
                }
                
                const newItem = {
                    id: `${Date.now()}-${activeChecklist.items.length}`,
                    text,
                    note: '',
                    completed: false
                };
                
                const updatedChecklist = {
                    ...activeChecklist,
                    items: [...activeChecklist.items, newItem]
                };
                
                updateChecklist(activeChecklist.id, updatedChecklist);
            };

            const renameChecklist = (checklistId, newName) => {
                const checklist = manager.checklists.find(c => c.id === checklistId);
                if (!checklist) return;
                
                const updatedChecklist = {
                    ...checklist,
                    name: newName
                };
                
                updateChecklist(checklistId, updatedChecklist);
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {manager.checklists.length > 0 && (
                            <div>
                                <TabList
                                    checklists={manager.checklists}
                                    activeChecklistId={manager.activeChecklistId}
                                    onTabClick={setActiveChecklist}
                                    onTabClose={deleteChecklist}
                                    onTabRename={renameChecklist}
                                    onTabReorder={reorderChecklists}
                                />
                                
                                {activeChecklist && (
                                    <div>
                                        <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-4">
                                            <h2 className="text-lg sm:text-xl font-semibold text-gray-900 truncate">{activeChecklist.name}</h2>
                                            <button
                                                onClick={resetCurrentChecklist}
                                                className="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition-colors text-sm w-full sm:w-auto"
                                            >
                                                チェックをリセット
                                            </button>
                                        </div>
                                        <Checklist 
                                            checklist={activeChecklist} 
                                            onToggle={toggleItem} 
                                            onUpdateNote={updateItemNote}
                                            onUpdateItem={updateItemText}
                                            onDeleteItem={deleteItem}
                                            onReorderItems={reorderItems}
                                            onAddItem={addItem}
                                        />
                                    </div>
                                )}
                            </div>
                        )}

                        {manager.checklists.length === 0 && !isLoading && (
                            <div className="text-center py-12">
                                <div className="text-gray-400 mb-4">
                                    <svg className="mx-auto h-16 w-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                                    </svg>
                                </div>
                                <h3 className="text-lg font-medium text-gray-900 mb-2">チェックリストがありません</h3>
                            </div>
                        )}

                        {/* 入力方法選択 */}
                        <div className="mt-6 sm:mt-8">
                            {!showTextInput ? (
                                <div className="space-y-4">
                                    {/* テキスト入力ボタン */}
                                    <div className="border border-dashed rounded p-4 sm:p-6 text-center border-gray-300 hover:border-gray-400 transition-colors">
                                        <button
                                            onClick={() => setShowTextInput(true)}
                                            className="text-blue-600 hover:text-blue-700 font-medium text-sm sm:text-base"
                                        >
                                            テキストからリストを作成
                                        </button>
                                    </div>

                                    {/* CSV File Selection */}
                                    <div
                                        className={`border border-dashed rounded p-4 sm:p-6 text-center transition-colors ${
                                            isDragOver
                                                ? 'border-blue-500 bg-blue-50'
                                                : 'border-gray-300 hover:border-gray-400'
                                        }`}
                                        onDrop={handleDrop}
                                        onDragOver={handleDragOver}
                                        onDragLeave={handleDragLeave}
                                    >
                                        <button
                                            onClick={() => fileInputRef.current?.click()}
                                            className="text-blue-600 hover:text-blue-700 font-medium text-sm sm:text-base"
                                            disabled={isLoading}
                                        >
                                            {isLoading ? '読み込み中...' : 'CSVファイルからリストを作成'}
                                        </button>
                                    </div>

                                    <input
                                        ref={fileInputRef}
                                        type="file"
                                        accept=".csv"
                                        onChange={handleFileInputChange}
                                        className="hidden"
                                    />
                                </div>
                            ) : (
                                <div className="bg-white rounded-lg shadow-md border border-gray-200 p-6">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-lg font-semibold text-gray-900">新しいチェックリストを作成</h3>
                                        <button
                                            onClick={() => {
                                                setShowTextInput(false);
                                                setChecklistName('');
                                                setTextInput('');
                                                setError(null);
                                            }}
                                            className="text-gray-400 hover:text-gray-600"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>

                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                チェックリスト名
                                            </label>
                                            <input
                                                type="text"
                                                value={checklistName}
                                                onChange={(e) => setChecklistName(e.target.value)}
                                                placeholder="例: 持ち物リスト"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                チェック項目（1行に1項目。カンマ区切りで備考も追加可能）
                                            </label>
                                            <textarea
                                                value={textInput}
                                                onChange={(e) => setTextInput(e.target.value)}
                                                placeholder={'スマホ\n財布\n時計\n充電器\nUSB-Cケーブル'}
                                                rows={10}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                                            />
                                            <p className="mt-2 text-xs text-gray-500">
                                                ※ 1行に1項目を入力してください<br />
                                                ※ 「項目名,備考」の形式で備考も追加できます
                                            </p>
                                        </div>

                                        <div className="flex gap-2">
                                            <button
                                                onClick={handleTextInputSubmit}
                                                className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-medium"
                                            >
                                                チェックリストを作成
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setShowTextInput(false);
                                                    setChecklistName('');
                                                    setTextInput('');
                                                    setError(null);
                                                }}
                                                className="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors font-medium"
                                            >
                                                キャンセル
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {error && (
                                <div className="mt-2 p-2 bg-red-50 border border-red-200 rounded text-sm text-red-600">
                                    {error}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
